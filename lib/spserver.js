"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var fs=_interopDefault(require("fs")),process$1=_interopDefault(require("process")),path=_interopDefault(require("path")),http=_interopDefault(require("http")),https=_interopDefault(require("https")),mustache=_interopDefault(require("mustache")),mimeTypes=_interopDefault(require("mime-types")),crypto=_interopDefault(require("crypto")),fsExtra=_interopDefault(require("fs-extra")),lruCache=_interopDefault(require("lru-cache")),nodemailer=_interopDefault(require("nodemailer")),formidable=_interopDefault(require("formidable")),AppError=function(e,t){this.errorMsg=e,this.errorDetail=t},app_error=AppError,Namespace={USER:"u",TEMPLATE:"t",INDEX_FILE:"i",LOGIN_FILE:"li",LOGOUT_FILE:"lo",SITE:"s"},namespace=Namespace,SPConstants={RETURN_SUCCESS:0,RETURN_LOGIN_REQUIRED:-1,RETURN_APP_ERROR:-2,RETURN_ACCESS_DENIED:-3,RETURN_INTERNAL_ERROR:-4,RETURN_NO_CONNECTION:-5,RETURN_INVALID_REQUEST:-6,SINGLE_SITE_ACCESS_TYPES:[{label:"msg_protected",value:"PROTECTED"},{label:"msg_public",value:"PUBLIC"}],MULTI_SITE_ACCESS_TYPES:[{label:"msg_private",value:"PRIVATE"},{label:"msg_protected",value:"PROTECTED"},{label:"msg_public",value:"PUBLIC"}],FILE_ACCESS_TYPE_PUBLIC:"PUBLIC",FILE_ACCESS_TYPE_PRIVATE:"PRIVATE",FILE_ACCESS_TYPE_AVATAR:"AVATAR",ROLE_SUPERADMIN:"SUPERADMIN",ROLE_ADMIN:"ADMIN",ROLE_MODERATOR:"MODERATOR",ROLE_REVIEWER:"REVIEWER",ROLE_MEMBER:"MEMBER",ROLE_GUEST:"GUEST",ROLE_PLATINUM:"PLATINUM",ROLE_GOLD:"GOLD",ROLE_SILVER:"SILVER",ROLE_BRONZE:"BRONZE",ROLES:[{label:"msg_role_superadmin",value:"SUPERADMIN"},{label:"msg_role_admin",value:"ADMIN"},{label:"msg_role_moderator",value:"MODERATOR"},{label:"msg_role_reviewer",value:"REVIEWER"},{label:"msg_role_member",value:"MEMBER"},{label:"msg_role_guest",value:"GUEST"},{label:"msg_role_platinum",value:"PLATINUM"},{label:"msg_role_gold",value:"GOLD"},{label:"msg_role_silver",value:"SILVER"},{label:"msg_role_bronze",value:"BRONZE"}],FORM_FIELD_HIDDEN:"hidden",FORM_FIELD_TEXTAREA:"textarea",FORM_FIELD_HTML:"html",FORM_FIELD_TEXT:"text",FORM_FIELD_PASSWORD:"password",FORM_FIELD_SELECT:"select",FORM_FIELD_CHECKBOX:"checkbox",FORM_FIELD_RADIO:"radio",FORM_FIELD_DATE:"date",FORM_FIELD_TIMESTAMP:"timestamp",FORM_FIELD_FILE:"file",FORM_FIELD_GROUP:"group",DATA_TYPE_INT:"int",DATA_TYPE_FLOAT:"float",DATA_TYPE_EMAIL:"email",DATA_TYPE_URL:"url",DATA_TYPE_US_PHONE:"us-phone",DATA_TYPE_OBJECT:"object",DATA_TYPE_ARRAY:"array",CODE_REGISTRATION:0,CODE_PASSWORD_RESET:1},constants=SPConstants,_CORS_ORIGIN=null,_JSON_RESPONSE_HEADER=null,SPResponse={init(e){_CORS_ORIGIN=e.CORS_ORIGIN,_JSON_RESPONSE_HEADER=_CORS_ORIGIN?{"Content-Type":"application/json","Access-Control-Allow-Origin":_CORS_ORIGIN,"Access-Control-Allow-Credentials":"true"}:{"Content-Type":"application/json","Access-Control-Allow-Credentials":"true"}},success(e,t,r){let n={};r||(r=_JSON_RESPONSE_HEADER),n.status=constants.RETURN_SUCCESS,n.result=t,e.writeHead(200,r),e.end(dehydrate(n))},loginRequired(e){let t={};t.status=constants.RETURN_LOGIN_REQUIRED,e.writeHead(200,_JSON_RESPONSE_HEADER),e.end(JSON.stringify(t))},accessDenied(e){let t={};t.status=constants.RETURN_ACCESS_DENIED,e.writeHead(200,_JSON_RESPONSE_HEADER),e.end(JSON.stringify(t))},internalError(e,t){let r={};r.status=constants.RETURN_INTERNAL_ERROR,e.writeHead(200,_JSON_RESPONSE_HEADER),e.end(JSON.stringify(r)),t&&console.log(t)},appError(e,t,r,n){let s={};n||(n=_JSON_RESPONSE_HEADER),s.status=constants.RETURN_APP_ERROR,s.error=t,s.result=r,e.writeHead(200,n),e.end(JSON.stringify(s))},options(e){_CORS_ORIGIN?e.writeHead(200,{"Content-Type":"text/plain","Access-Control-Allow-Origin":_CORS_ORIGIN,"Access-Control-Allow-Credentials":"true","Access-Control-Allow-Headers":"Content-Type,SP-Site-URL,SP-File-Upload"}):e.writeHead(200,{"Content-Type":"text/plain","Access-Control-Allow-Credentials":"true","Access-Control-Allow-Headers":"Content-Type,SP-Site-URL,SP-File-Upload"}),e.write(""),e.end()},invalidRequest(e,t){let r={};return r.status=constants.RETURN_INVALID_REQUEST,r.error=t,e.writeHead(400,_JSON_RESPONSE_HEADER),e.end(JSON.stringify(r))},notFound(e){e.writeHead(404,{"Content-Type":"text/plain"}),e.write("404 Not Found\n"),e.end()},staticInternalError(e){e.writeHead(500,{"Content-Type":"text/plain"}),e.write("Sorry! Something went wrong, please try your request later.\n"),e.end()},sendFile(e,t,r,n){n||(n={}),n["Content-Type"]=getContentType(r),e.writeHead(200,n),e.write(t),e.end()},getHeaders:e=>_CORS_ORIGIN?{"Set-Cookie":e,"Content-Type":"application/json","Access-Control-Allow-Credentials":"true","Access-Control-Allow-Origin":_CORS_ORIGIN}:{"Set-Cookie":e,"Content-Type":"application/json","Access-Control-Allow-Credentials":"true"},getUnloggedHeaders:()=>_JSON_RESPONSE_HEADER};function dehydrate(e){return e?(Object.keys(e).forEach(function(t,r){null==e[t]&&(e[t]=void 0)}),JSON.stringify(e)):""}function getContentType(e){if(!e)return"application/octet-stream";if(e.endsWith(".vue"))return mimeTypes.lookup("txt");let t=mimeTypes.lookup(e);return t||"application/octet-stream"}var response=SPResponse,Services={},InternalServices={},ServiceDirectory={setServices(e){Services=e[0],InternalServices=e[1]},getService:e=>Services[e],getInternalService:e=>InternalServices[e]},service_directory=ServiceDirectory,CommonUtils={createPropsForm(e){if(e)return Array.isArray(e)?createPropsFormFromArray(e):createPropsFormFromObject(e)},isObject:function(e){return!!e&&("object"==typeof e&&!Array.isArray(e))},isFunction:function(e){return e&&"[object Function]"==={}.toString.call(e)}};function createPropsFormFromArray(e){var t={},r=[];t.fields=r;for(let t=0;t<e.length;t++){let n=e[t],s={};s.name=n,s.type="text",s.label=n,r.push(s)}return t}function createPropsFormFromObject(e){let t={},r=[];return t.fields=r,Object.keys(e).forEach(function(t){let n=e[t];if(!n)return;let s={};if(s.name=t,s.label=t,CommonUtils.isFunction(n)){if(!n.name)return;if(!["String","Number","Boolean","Object","Array"].includes(n.name))return;s.type=computeFieldType(n),s.dataType=computeFieldDataType(n)}else CommonUtils.isObject(n)?(s.type=computeFieldType(n.type),s.dataType=computeFieldDataType(n.type),s.required=n.required,n.validator&&(s.propValidator=n.validator)):Array.isArray(n)&&(s.type=constants.FORM_FIELD_TEXTAREA);r.push(s)}),t}function computeFieldType(e){return e?"Object"==e.name?constants.FORM_FIELD_TEXTAREA:"Date"==e.name?constants.FORM_FIELD_TIMESTAMP:"Boolean"==e.name?constants.FORM_FIELD_CHECKBOX:constants.FORM_FIELD_TEXT:constants.FORM_FIELD_TEXT}function computeFieldDataType(e){return e?"Number"==e.name?constants.DATA_TYPE_FLOAT:"Object"==e.name?constants.DATA_TYPE_OBJECT:"Array"==e.name?constants.DATA_TYPE_ARRAY:void 0:void 0}var common_util=CommonUtils;const _DEFAULT_SESSION_KEY="9xvwd658",Util={mixin:function(e,t){t&&common_util.isObject(t)&&Object.keys(t).forEach(function(r,n){var s=t[r];e[r]&&common_util.isObject(s)?mixin(e[r],s):e[r]=s})},union:function(e,t){return[...new Set([...e,...t])]},stripLastSlash:e=>e&&e.endsWith("/")?e.substring(0,e.length-1):e,partialCopy(e,t){var r=t.length,n={};for(let s=0;s<r;s++)e[t[s]]&&(n[t[s]]=e[t[s]]);return n},partialCopyNeg(e,t){var r=Util.shallowCopy(e),n=t.length;for(let e=0;e<n;e++)r[t[e]]=void 0;return JSON.parse(JSON.stringify(r))},shallowCopy(e){var t=Object.keys(e),r=t.length,n={};for(let s=0;s<r;s++)e[t[s]]&&(n[t[s]]=e[t[s]]);return n},deepCopy(e){var t=JSON.stringify(e);return JSON.parse(t)},underscoreToCamel:e=>e.replace(/_([a-z])/g,function(e){return e[1].toUpperCase()}),parsePGArray(e){var t=e.replace("{","");t=(t=t.replace("}","")).split(",");for(let e=0;e<t.length;e++)t[e]=t[e].trim();return t},getFileNameFromPath(e){var t=e.lastIndexOf("/");return-1==t&&(t=e.lastIndexOf("\\")),e.substring(t+1)},getDirectoryFromPath(e){var t=e.lastIndexOf("/");return-1==t&&(t=e.lastIndexOf("\\")),e.substring(0,t)},getExtension(e){var t=e.lastIndexOf(".");return-1==t?"":e.substring(t+1)},isDir:e=>fs.existsSync(e)&&fs.lstatSync(e).isDirectory(),isFile:(e,t)=>!(!fs.existsSync(e)||fs.lstatSync(e).isDirectory())&&(!t||e.endsWith(t)),toTitleCase:(e,t)=>e=(e=t?e.replace(/(_|-|\s+)\w/g,function(e){return" "+e[e.length-1].toUpperCase()}):e.replace(/(_|-|\s+)\w/g,function(e){return e[e.length-1].toUpperCase()}))[0].toUpperCase()+e.substring(1),decrypt(e){const t=crypto.createDecipher("aes128",process$1.env.SP_SESSION_KEY||"9xvwd658");let r=t.update(e,"hex","utf8");return r+=t.final("utf8")},encrypt(e){var t=crypto.createCipher("aes128",process$1.env.SP_SESSION_KEY||"9xvwd658"),r=t.update(e,"utf8","hex");return r+=t.final("hex")},lookupComponentName(e,t){var r=t.siteDef;if(!r)return null;var n=r.pages;if(!n)return null;for(let t=0;t<n.length;t++){let r=lookupComponentNameHelper(e,n[t]);if(r)return r}}};function lookupComponentNameHelper(e,t){if(t.components)for(let r=0;r<t.components.length;r++)if(t.components[r].id===e)return t.components[r].name;if(t.containers)for(let r=0;r<t.containers.length;r++){let n=lookupComponentNameHelper(e,t.containers[r]);if(n)return n}if(t.pages)for(let r=0;r<t.pages.length;r++){let n=lookupComponentNameHelper(e,t.pages[r]);if(n)return n}return null}var util=Util,Cache=null,_BUILD_OUTPUT=null,_PROTOCOL="//",_INDEX_FILE=null,_PAGE_LAYOUTS=null,_ASSETS_BASE_DIR=null,_SRC_BASE_DIR=null,_CONFIG=null;const LocalFileServer={init(e,t){_CONFIG=e,_BUILD_OUTPUT=t;var r=process$1.env.SP_DIST_DIR?path.resolve(process$1.env.SP_DIST_DIR):path.resolve(process$1.env.SP_APP_BASE,"dist");process$1.env.SP_DIST_DIR||"production"==process$1.env.NODE_ENV?(_ASSETS_BASE_DIR=path.resolve(r,"client"),_SRC_BASE_DIR=_ASSETS_BASE_DIR):(_ASSETS_BASE_DIR=path.resolve(process$1.env.SP_APP_BASE,"assets"),_SRC_BASE_DIR=path.resolve(process$1.env.SP_APP_BASE,"src","www")),_PAGE_LAYOUTS=_BUILD_OUTPUT?JSON.parse(_BUILD_OUTPUT.code["page_layouts.json"]):JSON.parse(fs.readFileSync(path.resolve(r,"server","resources","page_layouts.json"))),Cache=service_directory.getInternalService("Cache").permanentCache,LocalFileServer.readIndexFile()},getIndexFileLocation:()=>util.isFile(path.resolve(_SRC_BASE_DIR,"index.html"))?path.resolve(_SRC_BASE_DIR,"index.html"):path.resolve(process$1.env.SP_HOME,"dev","app_minimal","src","www","index.html"),readIndexFile(){var e=this.getIndexFileLocation();_INDEX_FILE=fs.readFileSync(e,"utf-8"),Cache.reset()},async handleSPFileRequest(e,t){if(t.includes(".."))return response.notFound(e);t.includes("?")&&(console.log(t),t=t.substring(0,t.indexOf("?")));var r=null;if(t.startsWith("components/")){if(_BUILD_OUTPUT){try{let r=t.substring("components/".length);response.sendFile(e,_BUILD_OUTPUT.components[r],t)}catch(e){console.log(e)}return}r=path.join(_ASSETS_BASE_DIR,t)}else{if(t.startsWith("spcomponents/")){let r=t.substring("spcomponents/".length);return void(_BUILD_OUTPUT?response.sendFile(e,fs.readFileSync(path.resolve(process$1.env.SP_HOME,"dist","components",r)),t):response.sendFile(e,fs.readFileSync(path.resolve(_ASSETS_BASE_DIR,"spcomponents",r)),t))}if(_BUILD_OUTPUT&&_BUILD_OUTPUT.code[t]){try{response.sendFile(e,_BUILD_OUTPUT.code[t],t)}catch(e){console.log(e)}return}if(fs.existsSync(path.join(_ASSETS_BASE_DIR,t)))r=path.resolve(_ASSETS_BASE_DIR,t);else{if(!process$1.env.SP_HOME)return console.error("Recived request for non-existent file: "+t),response.notFound(e);r=path.resolve(process$1.env.SP_HOME,"dev","app_minimal","assets",t)}}if(!util.isFile(r))return response.notFound(e);fs.readFile(r,(t,n)=>{if(t)console.log("Failed to deliver SP file: "+r),console.log(t),response.staticInternalError(e);else try{response.sendFile(e,n,r)}catch(e){console.log(e)}})},uncacheIndexFile(e){Cache.remove(namespace.INDEX_FILE,e)},async handleIndexFileRequest(e,t){await handlePortalFileRequest(e,t,_INDEX_FILE,namespace.INDEX_FILE)},getPageLayouts:()=>_PAGE_LAYOUTS,getAppComponents:()=>_APP_COMPONENTS};async function handlePortalFileRequest(e,t,r,n){try{var s=_PROTOCOL+e.headers.host+util.stripLastSlash(e.url),o=Cache.get(n,s);if(o){try{response.sendFile(t,o,"html")}catch(e){console.log(e)}return}var a=await service_directory.getService("SiteService").getSiteInfo({},{siteURL:s},{},["SUPERADMIN"]),i={};i.SITE_TITLE=a.title?a.title:_CONFIG.SITE_TITLE,i.SITE_KEYWORDS=a.keywords?a.keywords:_CONFIG.SITE_KEYWORDS,i.SITE_DESCR=a.descr?a.descr:_CONFIG.SITE_DESCR,i.SITE_AUTHOR=a.author?a.author:_CONFIG.SITE_AUTHOR,i.SITE_LOGO_URL=a.logoURL?a.logoURL:_CONFIG.CDN_URL+"/images/app_logo.png",i.CDN_URL=_CONFIG.CDN_URL,o=mustache.render(r,i),Cache.put(n,s,o),response.sendFile(t,o,"html")}catch(e){return console.log("Bad [index login logout ] .html request"),console.log(e.stack),void response.staticInternalError(t)}}var local_file_server=LocalFileServer,_COMPONENT_LIST=[],_COMPONENT_MAP={},_COMPONENT_SETTINGS={},ComponentRegistry={init(e){if("development"==process$1.env.NODE_ENV)_COMPONENT_LIST=e.componentMetadata.componentList,_COMPONENT_MAP=e.componentMetadata.componentMap,_COMPONENT_SETTINGS=e.componentMetadata.componentSettings;else{let e=process$1.env.SP_DIST_DIR?path.resolve(process$1.env.SP_DIST_DIR):path.resolve(process$1.env.SP_APP_BASE,"dist"),t=require(path.resolve(e,"server","resources","component_metadata.js"));for(let e=0;e<t.length;e++)_COMPONENT_LIST.push(t[e].metadata),_COMPONENT_MAP[t[e].metadata[0]]=t[e].metadata,_COMPONENT_SETTINGS[t[e].metadata[0]]=t[e].settings}},getComponents:()=>_COMPONENT_LIST,isComponentRegistered:e=>_COMPONENT_MAP[e],getComponentSettings:e=>_COMPONENT_SETTINGS[e]},component_registry=ComponentRegistry,_WATCH=null;const AppService={init(e){"development"==process$1.env.NODE_ENV&&(_WATCH={port:35729|process$1.env.SP_RELOAD_PORT})},async getAppInfo(e,t,r,n){let s={watch:_WATCH};return s.user=await service_directory.getService("UserService").getUserInfo(e,t,r,n),s.site=await service_directory.getService("SiteService").getSiteInfo(e,t,r,n),s.appComponents=component_registry.getComponents(),s.adminData={},n&&n.includes("SUPERADMIN")&&(s.adminData.pageLayouts=local_file_server.getPageLayouts()),s}};var app_service=AppService;const UserService={async getUserInfo(e,t,r,n){if(!r)return null;var s={};return s.firstName=r.firstName,s.lastName=r.lastName,s.screenName=r.screenName,s.displayName=r.displayName,s.email=r.email,s.avatarURL=r.avatar,s.roles=n,s},getProfileInfo:(e,t,r,n)=>({}),updateProfile:async(e,t,r,n)=>null,async handleLoginPrereqsResponse(e,t,r,n){},async updateUserData(e,t,r,n){}};var simple_user_service=UserService,SPValidator={emailRegex:/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,urlRegex:/[-a-zA-Z0-9@:%_\+.~#?&\/\/=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&\/\/=]*)?/gi,isValidUSPhone:function(e){return 10===e.match(/\d/g).length},isValidEmail:function(e){return e.match(SPValidator.emailRegex)},isValidURL:function(e){return e.match(SPValidator.urlRegex)},validateField:function(e,t){if(e.type==constants.FORM_FIELD_HIDDEN||e.type==constants.FORM_FIELD_GROUP)return null;var r=null;if(e.required&&(!t&&0!==t||t instanceof Array&&0==t.length))r=e.type==constants.FORM_FIELD_CHECKBOX?"error_checkbox_required":e.type==constants.FORM_FIELD_RADIO?"error_radio_required":e.type==constants.FORM_FIELD_SELECT?"error_select_required":e.type==constants.FORM_FIELD_FILE?"error_file_required":"error_required";else{if(null==t||null==t||"string"==typeof t&&""==t.trim())return null;if(e.customValidator)r=e.customValidator(e,t);else if(e.propValidator)e.propValidator(t)||(r="error_invalid_value");else if(e.dataType==constants.DATA_TYPE_EMAIL){if(SPValidator.isValidEmail(t))return null;r="error_invalid_email"}else if(e.dataType==constants.DATA_TYPE_URL){if(SPValidator.isValidURL(t))return null;r="error_invalid_url"}else if(e.dataType==constants.DATA_TYPE_US_PHONE){if(SPValidator.isValidUSPhone(t))return null;r="error_invalid_phone_number"}else if(e.dataType==constants.DATA_TYPE_OBJECT)try{return JSON.parse(t),null}catch(e){r="error_invalid_json"}else if(e.dataType==constants.DATA_TYPE_ARRAY)try{let e=JSON.parse(t);if(Array.isArray(e))return null;r="error_invalid_array"}catch(e){r="error_invalid_array"}else if(e.pattern&&!e.pattern.test(t))r="error_invalid_value";else if(e.dataType==constants.DATA_TYPE_INT)if(Array.isArray(t)){for(let e=0;e<fielValue.length;e++)if(t[e]!=parseInt(t,10)){r="error_must_be_int";break}}else t!=parseInt(t,10)&&(r="error_must_be_int");else if(e.dataType==constants.DATA_TYPE_FLOAT)if(Array.isArray(t)){for(let e=0;e<fielValue.length;e++)if(t[e]!=parseFloat(t,10)){r="error_must_be_float";break}}else t!=parseFloat(t,10)&&(r="error_must_be_float");else e.minValue&&t<e.minValue?r="error_value_cannot_be_less_than":e.maxValue&&t>e.maxValue?r="error_value_cannot_be_greater_than":e.minLength&&t.length<e.minLength?r="error_length_cannot_be_less_than":e.maxLength&&t.length>e.maxLength&&(r="error_length_cannot_be_greater_than")}return e.errorMsg&&r&&(r=e.errorMsg),r},validateForm:function(e,t,r){var n=SPValidator.validateFields(e.fields,t,r);if(n>0)return n;if(e.constraints){var s=e.constraints.length;for(let a=0;a<s;i++){var o=e.constraints[a](e,t);if(null!=o){for(let e in o)r[e]=o[e],n++;return n}}}return n},validateFields:function(e,t,r){var n=e.length,s=0;for(let a=0;a<n;a++)if(e[a].type!=constants.FORM_FIELD_HIDDEN)if(e[a].type==constants.FORM_FIELD_GROUP)s+=this.validateFields(e[a].fields,t,r);else{var o=SPValidator.validateField(e[a],t[e[a].name]);r[e[a].name]=o,null!=o&&s++}return s}},validator=SPValidator,_PAGE_MAP={};const _PAGE_STATUS_ACCESS_CHECKED=1,_PAGE_STATUS_EMPTY=2,_PAGE_STATUS_PARTIAL=3,SiteUtil={getPageTemplate(e){if(_PAGE_MAP[e])return _PAGE_MAP[e]},validateSiteDef(e){var t=[],r={},n={},s={};for(let o=0;o<e.pages.length;o++)n={},SiteUtil.validatePage(e.pages[o],o,t,s,r,n);return 0==t.length?null:t},validatePage(e,t,r,n,s,o){if(e)if(e.pages)e.label||r.push("Missing label for folder "+t),e.pages||(e.pages=[]),e.pages.forEach(function(t,a){o={},SiteUtil.validatePage(t,e.label+":"+a,r,n,s,o)});else{e.label||r.push("Missing label for page "+t),e.path?n[e.path]?r.push("Duplicate page path: "+e.path):e.path.match(/^[a-z0-9]+$/i)?n[e.path]=!0:r.push("Invalid page path: "+e.path):r.push("Missing path for page "+t);for(let n=0;n<e.containers.length;n++)SiteUtil.validateContainer(e.containers[n],t,r,s,o)}else r.push("Null page "+t)},validateContainer(e,t,r,n,s){if(e.containers&&e.containers.length>0&&e.components&&e.components.length>0)r.push("Container on page "+t+" has components AND containers.");else{if(s[e.id]?r.push("Duplicate container ID: "+e.id):s[e.id]=!0,e.components)for(let s=0;s<e.components.length;s++)SiteUtil.validateComponent(e.components[s],t,r,n);if(e.containers)for(let o=0;o<e.containers.length;o++)SiteUtil.validateContainer(e.containers[o],t,r,n,s)}},validateComponent(e,t,r,n){if(n[e.id]?r.push("Duplicate component ID: "+e.id):n[e.id]=!0,e.name?component_registry.isComponentRegistered(e.name)||r.push("Unregistered component: "+e.name):r.push("Component name is missing for ID: "+e.id),e.config&&Object.keys(e.config).length>0){var s=component_registry.getComponentSettings(e.name);if(s){let t={};validator.validateForm(s,e.config,t)>0&&r.push("Invalid configuration for component ID "+e.id+" : "+JSON.stringify(t))}else r.push("Component "+e.name+" does not have a settings form configured.")}},async getSiteInfo(e,t,r,n){if("PUBLIC"!=e.accessType&&!r)return null;if("PRIVATE"==e.accessType&&0==n.length)return null;if(n.includes("SUPERADMIN")||n.includes("ADMIN")){return util.shallowCopy(e)}var s=util.partialCopy(e,["tenantId","id","loginUrl","logoURL","siteURL","siteData"]),o=computeSiteDef(e,r,n);return s.siteDef=o,s}};function computeSiteDef(e,t,r){var n=e.siteDef;if(!n.pages||0==n.pages.length||n.accessChecked)return n;var s={};if(t){s.MEMBER=!0;var o=r.length;for(let e=0;e<o;e++)s[r[e]]=!0}else s.GUEST=!0;return getViewableDef(n,s)}function getViewableDef(e,t){if(e.accessChecked)return e;var r=[],n=e.pages.length,s=!0;for(let l=0;l<n;l++){var o=e.pages[l];if(o.accessChecked)r.push(o);else if(checkAccess(o.roles,t)){var a=null,i=null;(i=o.pages?(a=getViewableDef(o,t))?a.accessChecked?_PAGE_STATUS_ACCESS_CHECKED:_PAGE_STATUS_PARTIAL:_PAGE_STATUS_EMPTY:constructViewablePage(o,t,a=util.partialCopyNeg(o,["containers","components"])))!==_PAGE_STATUS_ACCESS_CHECKED&&(s=!1),i!==_PAGE_STATUS_EMPTY&&(r.push(a),i===_PAGE_STATUS_ACCESS_CHECKED&&(o.accessChecked=!0))}else s=!1}if(s)return e.accessChecked=!0,e;if(0==r.length)return null;var l=util.partialCopyNeg(e,["pages"]);return l.pages=r,l}function checkAccess(e,t){if(!e||0==e.length)return!0;if(!t)return!1;var r=e.length;for(let n=0;n<r;n++)if(t[e[n]])return!0;return!1}function constructViewablePage(e,t,r){var n=!1,s=[];if(e.components)for(let r=0;r<e.components.length;r++)e.components[r].roles&&e.components[r].roles.length>0&&(n=!0),checkAccess(e.components[r].roles,t)&&s.push(e.components[r]);s.length>0&&(r.components=s);let o=[];if(e.containers)for(let r=0;r<e.containers.length;r++){let s=util.partialCopyNeg(e.containers[r],["containers","components"]);if(e.containers[r].roles&&(n=!0,!checkAccess(e.containers[r].roles,t)))continue;let a=constructViewablePage(e.containers[r],t,s);a!=_PAGE_STATUS_EMPTY?(o.push(s),a==_PAGE_STATUS_PARTIAL&&(n=!0)):n=!0}return o.length>0&&(r.containers=o),0==s.length&&0==o.length?_PAGE_STATUS_EMPTY:n?_PAGE_STATUS_PARTIAL:_PAGE_STATUS_ACCESS_CHECKED}var site_util=SiteUtil,_SITE_TEMPLATE_DIR=null,_SITE_INFO_PATH=null,_SITE_INFO=null;const StaticSiteService={ACL:{setComponentConfig:[constants.ROLE_ADMIN,constants.ROLE_SUPERADMIN],saveSiteDef:[constants.ROLE_SUPERADMIN],saveSiteMetadata:[constants.ROLE_ADMIN,constants.ROLE_SUPERADMIN],saveSiteDefAs:[constants.ROLE_SUPERADMIN]},async init(){_SITE_TEMPLATE_DIR=process$1.env.SP_DIST_DIR?path.resolve(process$1.env.SP_DIST_DIR,"server"):path.resolve(process$1.env.SP_APP_BASE,"server"),_SITE_INFO_PATH=path.join(_SITE_TEMPLATE_DIR,"app.json"),fs.existsSync(_SITE_INFO_PATH)?_SITE_INFO=JSON.parse(fs.readFileSync(_SITE_INFO_PATH,"utf8")):(_SITE_INFO=JSON.parse(fs.readFileSync(path.join(process$1.env.SP_HOME,"dev","app_minimal","server","app.json"),"utf8")),saveSiteInfo())},getSiteInfo:async(e,t,r,n)=>await site_util.getSiteInfo(_SITE_INFO,t,r,n),async setComponentConfig(e,t,r){if(!e.component_id||!e.config)throw new Error("Missing one or more required parameters: component_id, config");var n=await util.lookupComponentName(e.component_id,_SITE_INFO);if(!n)throw new Error("Invalid component ID");var s=component_registry.getComponentSettings(n);if(!s)throw new Error("Component "+n+" does not have a settings form configured.");var o={};if(validator.validateForm(s,e.config,o)>0)return new app_error("error_please_correct_errors",o);var a=_SITE_INFO.siteData;a||(a={});var i=a.componentConfig;i||(i={}),i["sp_"+e.component_id]=e.config,a.componentConfig=i,_SITE_INFO.siteData=a,saveSiteInfo()},async saveSiteMetadata(e,t,r){_SITE_INFO.title=e.title,_SITE_INFO.author=e.author,_SITE_INFO.descr=e.descr,_SITE_INFO.keywords=e.keywords,_SITE_INFO.accessType=e.accessType;var n=_SITE_INFO.theme?_SITE_INFO.theme:"",s=e.theme?e.theme:"";_SITE_INFO.theme=e.theme,saveSiteInfo(),n!=s&&local_file_server.uncacheIndexFile(t.siteURL)},async saveSiteDefAs(e,t,r){if(!e.name)throw new Error("Missing required parameter: name");if(!e.overwrite&&fs.existsSync(path.join(_SITE_TEMPLATE_DIR,e.name+".json")))return new app_error("error_template_exists");saveSiteInfo(path.join(_SITE_TEMPLATE_DIR,e.name+".json")),_SITE_INFO_PATH=_SITE_TEMPLATE_DIR+"/"+e.name+".json"},async saveSiteDef(e,t,r){if(!e.siteDef)throw new Error("Missing one or more required parameters: siteDef");var n=site_util.validateSiteDef(e.siteDef);if(n)return new app_error("Invalid site def",n);_SITE_INFO.siteDef=e.siteDef,saveSiteInfo()}};function saveSiteInfo(e){mergeComponentConfig(),removeAccessFlag(_SITE_INFO.siteDef),e?fs.writeFileSync(e,JSON.stringify(_SITE_INFO)):fs.writeFileSync(_SITE_INFO_PATH,JSON.stringify(_SITE_INFO))}function removeAccessFlag(e){if(e.accessChecked&&(e.accessChecked=void 0),e.pages)for(let t=0;t<e.pages.length;t++)removeAccessFlag(e.pages[t]);if(e.containers)for(let t=0;t<e.containers.length;t++)removeAccessFlag(e.containers[t]);if(e.components)for(let t=0;t<e.components.length;t++)removeAccessFlag(e.components[t]);return e}function mergeComponentConfig(){_SITE_INFO.siteData&&_SITE_INFO.siteData.componentConfig&&(Object.keys(_SITE_INFO.siteData.componentConfig).forEach(function(e,t){var r=_SITE_INFO.siteData.componentConfig[e],n=e.substring(e.indexOf("_")+1),s=findComponentWithId(_SITE_INFO.siteDef,n);s&&(s.config||(s.config={}),util.mixin(s.config,r))}),_SITE_INFO.siteData.componentConfig=void 0)}function findComponentWithId(e,t){for(let n=0;n<e.pages.length;n++){var r=findComponentWithIdHelper(e.pages[n],t);if(r)return r}}function findComponentWithIdHelper(e,t){if(e.components)for(let r=0;r<e.components.length;r++)if(e.components[r].id==t)return e.components[r];if(e.containers)for(let n=0;n<e.containers.length;n++){var r=findComponentWithIdHelper(e.containers[n],t);if(r)return r}if(e.pages)for(let r=0;r<e.pages.length;r++){let n=findComponentWithIdHelper(e.pages[r],t);if(n)return n}}var simple_site_service=StaticSiteService;const _USER_INFO={firstName:"SinglePage",lastName:"Admin",screenName:"admin",displayName:"SP Admin"};var _USER_NAME="admin",_PASSWORD="admin",_CONFIG$1=null,_IS_HTTPS=null;const SessionService={async init(e){_CONFIG$1=e,_IS_HTTPS=e.IS_HTTPS,process$1.env.SP_USER_NAME&&(_USER_NAME=process$1.env.SP_USER_NAME.toLowerCase()),process$1.env.SP_PASSWORD&&(_PASSWORD=process$1.env.SP_PASSWORD)},async getSessionInfo(e,t){var r={},n=null;if(e.headers.cookie){var s=e.headers.cookie.match(new RegExp("(^| )"+_CONFIG$1.SESSION_COOKIE_NAME+"=([^;]+)"));if(s)try{let t=s[2],o=util.decrypt(t).split("."),a=parseInt(o[0]),i=Math.round((new Date).getTime()/1e3);if(i-a<=("1"==o[1]?_CONFIG$1.REMEMBER_ME_SESSION_TIMEOUT:_CONFIG$1.SESSION_TIMEOUT)&&(n=_USER_INFO,i-a>_CONFIG$1.LAST_ACCESS_REFRESH_INTERVAL)){let t=constructSessionCookie(e,n.id,1,parseInt(o[1]));r.headers=response.getHeaders(t)}}catch(e){console.log("Received invalid session cookie."),console.log(e)}}return r.clientInfo=constructClientInfo(e),r.userInfo=n,r.roles=n?["SUPERADMIN"]:["GUEST"],r},async login(e,t,r){if(r.params&&r.params.username&&r.params.password){if(r.params.username.toLowerCase()==_USER_NAME&&r.params.password==_PASSWORD){var n=constructSessionCookie(e,0,1,r.params.remember_me);return response.success(t,{},response.getHeaders(n))}response.appError(t,"error_invalid_username_or_password")}else response.appError(t,"error_missing_username_or_password")},async logout(e,t,r){let n=constructLogoutCookie(e,t);response.success(t,{},response.getHeaders(n))},async changePassword(e,t,r){response.appError(t,"error_unsupported_operation")}};function constructSessionCookie(e,t,r,n){var s=Math.round((new Date).getTime()/1e3),o=_CONFIG$1.SESSION_COOKIE_NAME+"="+util.encrypt(s+"."+(n?"1":"0")+"."+t+"."+r);if(o+="; Path=/; HttpOnly",isSecureRequest(e)&&(o+="; Secure"),n){var a=(new Date).getTime()+1e3*_CONFIG$1.REMEMBER_ME_SESSION_TIMEOUT;o=o+"; Expires="+new Date(a).toUTCString()}return o}function constructLogoutCookie(e,t){var r=_CONFIG$1.SESSION_COOKIE_NAME+"="+util.encrypt("0.0."+t+".0")+"; Path=/; HttpOnly";return isSecureRequest(e)&&(r+="; Secure"),r=r+"; Expires="+new Date(0).toUTCString()}function constructClientInfo(e){var t=e.headers["sp-site-url"];if(!t)throw new Error("Missing site URL information.");var r={};return t=util.stripLastSlash(t),r.siteURL=t,r.tenantId=0,r.siteId=0,r}function isSecureRequest(e){return!!_IS_HTTPS||(e.connection.encrypted?(_IS_HTTPS=!0,!0):"https"===e.headers["x-forwarded-proto"]?(_IS_HTTPS=!0,!0):!(!e.headers.origin||!e.headers.origin.startsWith("https"))&&(_IS_HTTPS=!0,!0))}var simple_session_service=SessionService,_TABLES={},_SCHEMA={},_DB_DIR=null,_SP=null,_SCHEMA_FILE=null;const ObjectStore={async init(e,t){if(_SP=t,e.SIMPLE_OBJECT_STORE&&(_DB_DIR=e.SIMPLE_OBJECT_STORE.DB_DIR),!_DB_DIR){let e=process.env.SP_DIST_DIR?path.resolve(process.env.SP_DIST_DIR):path.resolve(process.env.SP_APP_BASE);_DB_DIR=path.resolve(e,"store","db")}await fsExtra.ensureDir(_DB_DIR),_SCHEMA_FILE=path.resolve(_DB_DIR,"schema.json"),fsExtra.existsSync(_SCHEMA_FILE)&&(_SCHEMA=await fsExtra.readJSON(_SCHEMA_FILE));let r=await fsExtra.readdir(_DB_DIR);for(let e=0;e<r.length;e++){let t=r[e];if(!t.startsWith("table_"))continue;let n=await fsExtra.readJSON(path.resolve(_DB_DIR,t));_TABLES[t.substring(6)]=n}},createType:async(e,t)=>_SCHEMA[e]?new _SP.AppError("Object type "+e+" already exists."):(_SCHEMA[e]=t,_TABLES[e]=[],await fsExtra.writeFile(path.resolve(_DB_DIR,"table_"+e+".json"),JSON.stringify(_TABLES[e])),await fsExtra.writeFile(_SCHEMA_FILE,JSON.stringify(_SCHEMA)),t),deleteType:async e=>_SCHEMA[e]?(await fsExtra.unlink(path.resolve(_DB_DIR,"table_"+e+".json")),_SCHEMA[e]=void 0,await fsExtra.writeFile(_SCHEMA_FILE,JSON.stringify(_SCHEMA)),e):new _SP.AppError("Object type "+e+" does not exists."),async updateType(e,t){throw new Error("Unsupported")},listTypes:async()=>Object.keys(_SCHEMA),getTypeSchema:async e=>_SCHEMA[e],async insert(e,t){if(!_TABLES[e])return new _SP.AppError("Object type does not exist");_TABLES[e].push(t),await fsExtra.writeFile(path.resolve(_DB_DIR,"table_"+e+".json"),_TABLES[e])},async update(e,t,r,n){if(!_TABLES[e])return new _SP.AppError("Object type does not exist");if(n)throw new Error("Update filter is currently not supported");{let n=_SCHEMA[e].primaryKey;if(!t[n])return new _SP.AppError("Missing object ID");let s=findObjectIndex(e,n,t[n]);if(-1==s)return new _SP.AppError("Non-existent object");t=JSON.parse(JSON.stringify(t)),r?r.forEach(r=>{_TABLES[e][s][r]=t[r]}):_TABLES[e]=t}await fsExtra.writeFile(path.resolve(_DB_DIR,"table_"+e+".json"),_TABLES[e])},async delete(e,t){if(!_TABLES[e])return new _SP.AppError("Object type does not exist");let r=_SCHEMA[e].primaryKey;for(let n=0;n<_TABLES[e].length;n++)if(_TABLES[e][n][r]==t)return await fsExtra.writeFile(path.resolve(_DB_DIR,"table_"+e+".json"),_TABLES[e]),_TABLES[e].splice(n,1);return null},async query(e){let t=e.objectType;if(!t)return new _SP.AppError("Invalid query spec. Must specify objectType");let r=[],n=e.limit?e.limit:1e3,s=e.offset?e.offset:0,o=0;if(_TABLES[t].length<=s)return r;if(!e.filter){let e=s,o=s+n;o>=_TABLES[t].length&&(o=_TABLES[t].length-1);for(let n=e;n<o;n++)r.push(JSON.parse(JSON.stringify(_TABLES[t][n])));return r}for(let e=0;e<_TABLES[t].length;e++){let a=match(_TABLES[t][e]);if(a){if(++o<s)continue;r.push(JSON.parse(JSON.stringify(a)))}if(r.length==n)return r}return r}};function findObjectIndex(e,t,r){for(let n=0;n<_TABLES[e].length;n++)if(_TABLES[e][n][t]==r)return n;return-1}function match(e,t){}var simple_object_store=ObjectStore,TRANSIENT_CACHE=null,PERMANENT_CACHE=null,PERISHABLE_CACHE=null,TransientCacheService={put(e,t,r){TRANSIENT_CACHE.set(e+":"+t,r)},remove(e,t){TRANSIENT_CACHE.del(e+":"+t)},get:(e,t)=>TRANSIENT_CACHE.get(e+":"+t),reset(){PERMANENT_CACHE.reset()}},PermanentCacheService={put(e,t,r){PERMANENT_CACHE.set(e+":"+t,r)},remove(e,t){PERMANENT_CACHE.del(e+":"+t)},get:(e,t)=>PERMANENT_CACHE.get(e+":"+t),reset(){PERMANENT_CACHE.reset()}},PerishableCacheService={put(e,t,r,n){PERISHABLE_CACHE.set(e+":"+t,r,n)},remove(e,t){PERISHABLE_CACHE.del(e+":"+t)},get:(e,t)=>PERISHABLE_CACHE.get(e+":"+t),reset(){PERMANENT_CACHE.reset()}},CacheService={init(e){var t={max:e.TRANSIENT_CACHE_MAX_SIZE},r={max:e.PERISHABLE_CACHE_MAX_SIZE,maxAge:e.PERISHABLE_CACHE_MAX_AGE};TRANSIENT_CACHE=new lruCache(t),PERISHABLE_CACHE=new lruCache(r),PERMANENT_CACHE=new lruCache}};CacheService.transientCache=TransientCacheService,CacheService.permanentCache=PermanentCacheService,CacheService.perishableCache=PerishableCacheService;var cache_service=CacheService,_CONFIG$2=null,smtpConfig={host:process$1.env.SMTP_HOST,port:process$1.env.SMTP_PORT,secure:!1,auth:{user:process$1.env.SMTP_USER,pass:process$1.env.SMTP_PASSWORD}},transporter=nodemailer.createTransport(smtpConfig);const EmailService={init(e){_CONFIG$2=e},async sendEmail(e,t,r,n,s){var o={from:e,to:t,subject:r,text:n,html:s};await transporter.sendMail(o)},async sendEmailWithTemplate(e,t,r,n){var s=await service_directory.getInternalService("TemplateService").evaluateTemplate(e,t,r,n);await EmailService.sendEmail(_CONFIG$2.SYSTEM_EMAIL_SENDER,r.email,s.subject,s.textBody,s.htmlBody)}};var email_service=EmailService,_UPLOAD_DIR=null;const FileStore={init(e){e.FILE_UPLOAD_DIR&&(_UPLOAD_DIR=path.resolve(e.FILE_UPLOAD_DIR))},async handleFileUpload(e,t){try{var r=(await service_directory.getService("SessionService").getSessionInfo(e,{})).userInfo;if(!r)return void response.loginRequired(t);var n=e.headers["sp-file-upload"];if(n!=constants.FILE_ACCESS_TYPE_AVATAR&&n!=constants.FILE_ACCESS_TYPE_PUBLIC&&n!=constants.FILE_ACCESS_TYPE_PRIVATE)return response.invalidRequest(t);var s=handleAvatarUpload;storeUploadedFiles(e,t,n,s,{jpeg:!0,jpg:!0,gif:!0,png:!0},r)}catch(e){response.internalError(t,e)}},handleFileDownload(e,t,r){var n=_UPLOAD_DIR+r;fs.readFile(n,(e,r)=>{if(e)return console.log("Failed to deliver static file: "+n),console.log(e),response.notFound(t);try{response.sendFile(t,r,n)}catch(e){console.log(e)}})},exists(e){if(e.includes(".."))return!1;var t=_UPLOAD_DIR+e;return fs.existsSync(t)}};var local_file_store=FileStore;function storeUploadedFiles(e,t,r,n,s,o){var a=new formidable.IncomingForm,i=[],l=[],c=null;a.type="multipart",a.keepExtensions=!0,a.encoding="utf-8",a.maxFieldsSize=2097152,a.maxFields=1e3,a.onPart=function(e){!e.filename||s[util.getExtension(e.filename)]?this.handlePart(e):c="error_unsupported_file_type"},a.on("field",function(e,t){l.push([e,t])}).on("file",function(e,t){i.push([e,t])}).on("end",function(){if(c)return response.appError(t,c);n(l,i,t,o)}),a.parse(e)}var Config={SITE_TITLE:"SinglePage.js",SITE_DESCR:"Web site built using SinglePage.js",SITE_KEYWORDS:"SinglePage.js, Vue.js",SITE_AUTHOR:"Padmanabh Dabke",EMAIL_LOGO_URL:"/images/app_logo.png",PERISHABLE_CACHE_MAX_SIZE:500,TRANSIENT_CACHE_MAX_SIZE:500,PERISHABLE_CACHE_MAX_AGE:3e5,AVATAR_SIZE:48,AVATAR_URL_PREFIX:"/files/avatar/",PUBLIC_FILES_URL_PREFIX:"/files/public/",PRIVATE_FILES_URL_PREFIX:"/files/private/",REMEMBER_ME_SESSION_TIMEOUT:2592e3,SESSION_TIMEOUT:3600,LAST_ACCESS_REFRESH_INTERVAL:60,SESSION_COOKIE_NAME:"sksession",MAX_FAILED_LOGIN_ATTEMPTS:5,GOOGLE:{verifyURL:"https://www.googleapis.com/oauth2/v3/tokeninfo?access_token=",userInfoURL:"https://www.googleapis.com/oauth2/v2/userinfo?access_token="},FACEBOOK:{userInfoURL:"https://graph.facebook.com/me?fields=email,first_name,last_name,gender&access_token="},HTML_TAGS_ALLOWED:["h1","h2","h3","h4","h5","h6","blockquote","p","a","ul","ol","nl","li","b","i","strong","em","strike","code","hr","br","div","table","thead","caption","tbody","tr","th","td","pre","iframe"],FORM_USER_PROFILE:{fields:[{name:"screen_name",label:"msg_screen_name",type:"text",maxLength:20},{name:"first_name",label:"msg_first_name",type:"text",maxLength:20,required:!0},{name:"last_name",label:"msg_last_name",type:"text",maxLength:20,required:!0},{name:"hidden_int",label:"Hidden Int",type:constants.FORM_FIELD_HIDDEN,value:"2",dataType:constants.DATA_TYPE_INT},{name:"textarea",label:"Text Area",type:constants.FORM_FIELD_TEXTAREA,required:!0},{name:"html",label:"HTML",type:constants.FORM_FIELD_HTML,required:!0},{name:"select_single",label:"Select",type:constants.FORM_FIELD_SELECT,required:!0,options:[{label:"Tiger",value:"0"},{label:"Lion",value:"1"},{label:"Monkey",value:"2"}]},{name:"select_multiple",label:"Multi Select",type:constants.FORM_FIELD_SELECT,required:!0,multiple:!0,options:[{label:"Tiger",value:"0"},{label:"Lion",value:"1"},{label:"Monkey",value:"2"}]},{name:"checkbox_single",label:"Check animals you like",type:constants.FORM_FIELD_CHECKBOX,required:!0,options:[{label:"I Agree",value:"0"}]},{name:"checkbox_group",label:"Check animals you like",type:constants.FORM_FIELD_CHECKBOX,required:!0,options:[{label:"Tiger",value:"0"},{label:"Lion",value:"1"},{label:"Monkey",value:"2"}]},{name:"radio",label:"Radio",type:constants.FORM_FIELD_RADIO,required:!0,options:[{label:"Tiger",value:"0"},{label:"Lion",value:"1"},{label:"Monkey",value:"2"}]}]}},server_config=Config,_HTML_TEMPLATE=null,_TEXT_TEMPLATE=null,_EMAIL_TEMPLATES=null,TemplateService={init(e){var t=null;process$1.env.SP_DIST_DIR?t=path.resolve(process$1.env.SP_DIST_DIR,"server","resources","email_template.html"):"development"!=process$1.env.NODE_ENV?t=path.resolve(process$1.env.SP_APP_BASE,"dist","server","resources","email_template.html"):(t=path.resolve(process$1.env.SP_APP_BASE,"src","templates","email_template.html"),fs.existsSync(t)||(t=path.resolve(process$1.env.SP_HOME,"dev","resources","email_templates","email_template.html"))),_HTML_TEMPLATE=fs.readFileSync(t,"UTF-8"),process$1.env.SP_DIST_DIR?t=path.resolve(process$1.env.SP_DIST_DIR,"server","resources","email_template.txt"):"development"!=process$1.env.NODE_ENV&&(t=path.resolve(process$1.env.SP_APP_BASE,"src","templates","email_template.txt"),fs.existsSync(t)||(t=path.resolve(process$1.env.SP_HOME,"dev","resources","email_templates","email_template.txt"))),_TEXT_TEMPLATE=fs.readFileSync(t,"UTF-8"),e.EMAIL_TEMPLATES&&Object.assign(_EMAIL_TEMPLATES,e.EMAIL_TEMPLATES)},getTemplate:async(e,t)=>(template=service_directory.getInternalService("Cache").permanentCache.get(namespace.TEMPLATE,e),template||(template=await getTemplateInternal(t,e)),template),async evaluateTemplate(e,t,r,n){template=await TemplateService.getTemplate(e,n.tenantId),output={},t.tenantName=server_config.SITE_TITLE,t.logoURL=server_config.EMAIL_LOGO_URL.startsWith("http")?server_config.EMAIL_LOGO_URL:n.siteURL+server_config.EMAIL_LOGO_URL,output.subject=Mustache.render(template.subject,t);var s=Mustache.render(template.preview,t);return output.textBody=Mustache.render(template.textBody,t),output.htmlBody=Mustache.render(template.htmlBody,t),uname=r.firstName?r.firstName:r.screen_name,output.textBody=Mustache.render(_TEXT_TEMPLATE,{body:output.textBody,username:uname}),output.htmlBody=Mustache.render(_HTML_TEMPLATE,{body:output.htmlBody,username:uname,subject:output.subject,preview:s}),output}};function getTemplateInternal(e,t){return _EMAIL_TEMPLATES[t]}_EMAIL_TEMPLATES={PASSWORD_CHANGE_ALERT_EMAIL:{subject:"Your {{tenantName}} password has been changed",preview:"You recently changed your password","text-body":"You recently changed your {{tenantName}} password. If you do not recall changing your password, please contact support for assistance.","html-body":"You recently changed your {{tenantName}} password. If you do not recall changing your password, please contact support for assistance."},PASSWORD_RESET_ALERT_EMAIL:{subject:"Your {{tenantName}} password has been reset",preview:"Please reset your password if you do not remember resetting your password recently.","text-body":"Your password has been reset. If you do not recall resetting your password, please contact support for assistance.","html-body":"Your password has been reset. If you do not recall resetting your password, please contact support for assistance."},RESET_PASSWORD_EMAIL:{subject:"{{tenantName}} password reset request",preview:"Link to reset your {{tenantName}} password","html-body":'<p>Please enter code {{{resetCode}}} on the login page if you still have it open. Alternatively click on the &quot;Reset Password&quot; button below to reset your password. \n  The password reset link will expire in 24 hours.</p>\n  <p style="text-align: center; padding: 4px;">\n    <a class="button-a button-a-primary" href="{{{siteURL}}}/login.html?mode=login&reset_code={{{resetCode}}}" style="background: #D35400; border: 1px solid #D35400; font-family: Lato, sans-serif; font-size: 15px; line-height: 15px; text-decoration: none; padding: 10px 12px; color: #ffffff; border-radius: 2px;">Reset Password</a>\n  </p>\n\n    <p style="text-align: center;">Password Reset URL: {{{siteURL}}}/login.html?mode=login&amp;reset_code={{{resetCode}}}</p>',"text-body":"Please enter code {{{resetCode}}} on the login page if you still have it open. Alternatively click on the URL below or copy it in your browser address bar. The password reset link will expire in 24 hours.\n       \n       Password Reset URL: {{{siteURL}}}/login.html?mode=login&reset_code={{{resetCode}}}\n  "},REGISTRATION_EMAIL:{subject:"{{tenantName}} registration request",preview:"Link to register with {{tenantName}}","html-body":'<p>Please enter code {{{regCode}}} on the registration page if you still have it open. Alternatively click on the &quot;Register&quot; button below to complete creating your user account. \n  The registration link will expire in 24 hours.</p>\n  <p style="text-align: center; padding: 4px;">\n    <a class="button-a button-a-primary" href="{{{siteURL}}}/login.html?mode=register&registration_code={{regCode}}" style="background: #D35400; border: 1px solid #D35400; font-family: Lato, sans-serif; font-size: 15px; line-height: 15px; text-decoration: none; padding: 10px 12px; color: #ffffff; border-radius: 2px;">Register</a>\n  </p>',"text-body":"Please enter code {{{regCode}}} on the registration page if you still have it open. Alternatively click on the URL below or copy it in your browser address bar. The registration link will expire in 24 hours.\n\n    Registration URL: {{{siteURL}}}/login.html?mode=register&registration_code={{{regCode}}}\n      "}};var simple_template_service=TemplateService;const BuiltinServices={AppService:app_service,UserService:simple_user_service,SiteService:simple_site_service,SessionService:simple_session_service,ObjectStore:simple_object_store,Cache:cache_service,EmailService:email_service,FileStore:local_file_store,TemplateService:simple_template_service};var builtin_services=BuiltinServices,_CONFIG$3=null,_SYSTEM_SERVICE_NAMES=["AppService","UserService","SiteService","SessionService"],_SYSTEM_INTERNAL_SERVICE_NAMES=["ObjectStore","Cache","EmailService","FileStore","TemplateService"],Services$1={},InternalServices$1={},SP={AppError:app_error,ServiceDirectory:service_directory},ServiceLoader={async init(e){_CONFIG$3=e,service_directory.setServices([Services$1,InternalServices$1]);var t=_SYSTEM_SERVICE_NAMES;for(let r=0;r<t.length;r++)e[t[r]]?Services$1[t[r]]=require(e[t[r]]):Services$1[t[r]]=builtin_services[t[r]];for(let r=0;r<t.length;r++)Services$1[t[r]].init&&await Services$1[t[r]].init(e,SP);t=_SYSTEM_INTERNAL_SERVICE_NAMES;for(let r=0;r<t.length;r++)e[t[r]]?InternalServices$1[t[r]]=require(e[t[r]]):InternalServices$1[t[r]]=builtin_services[t[r]];for(let r=0;r<t.length;r++)InternalServices$1[t[r]].init&&await InternalServices$1[t[r]].init(e,SP);await autoRegister()},async registerService(e,t){if(!t)throw console.error("Attempt to register service with null name."),new Error("Service name must be specified.");if(Services$1[e])throw console.error("Attempt to register service with duplicate name."),new Error("Duplicate service name "+e+".");if(!t)throw console.error("Attempt to register a null service object."),new Error("Null service object");t.init&&await t.init(_CONFIG$3,SP),Services$1[e]=t},serviceChanged(e,t){"add"==t?ServiceLoader.addService(e):"change"==t?ServiceLoader.updateService(e):"unlink"==t&&ServiceLoader.removeService(e)},async addService(e){if(!e.endsWith("Service.js"))return;let t=getServiceNameFromPath(e);try{let r=require(e);await ServiceLoader.registerService(t,r),console.log("Registered "+e+" as "+t)}catch(t){console.error("Failed to register service at path: "+e),console.error(t)}},async updateService(e){ServiceLoader.removeService(e),await ServiceLoader.addService(e)},removeService(e){e.endsWith(".js")&&(delete require.cache[e],delete Services$1[getServiceNameFromPath(e)],console.log("Removed service at path "+e))}},service_loader=ServiceLoader;function getServiceNameFromPath(e){let t=path.basename(e);return toTitleCase(t.substring(0,t.length-3))}async function autoRegister(e){var t=null;if(t=process$1.env.SP_DIST_DIR?path.resolve(process$1.env.SP_DIST_DIR,"server","services"):"development"==process$1.env.NODE_ENV?path.resolve(process$1.env.SP_APP_BASE,"server","services"):path.resolve(process$1.env.SP_APP_BASE,"dist","server","services"),fs.existsSync(t)){var r=fs.readdirSync(t);for(let e=0;e<r.length;e++)ServiceLoader.addService(path.resolve(t,r[e]))}}function toTitleCase(e,t){return e=(e=t?e.replace(/(_|-|\s+)\w/g,function(e){return" "+e[e.length-1].toUpperCase()}):e.replace(/(_|-|\s+)\w/g,function(e){return e[e.length-1].toUpperCase()}))[0].toUpperCase()+e.substring(1)}var ServiceGateway={async handleServiceRequest(e,t,r){if(!r)return console.error("Service call without any call data."),void response.internalError(t,"Service call without any call data.");let n=r.service;if(!n)return console.error("Service call without service name: "+JSON.stringify(r)),void response.internalError(t,"Service call without service name.");if("init"==r.method)return void response.internalError(t,"Sorry! You cannot call service init method remotely.");if(!service_directory.getService(n))return console.error("Service call with invalid service name: "+JSON.stringify(r)),void response.internalError(t,"Service call with non-existent service name: "+n);if("SessionService"==n)try{if("getSessionInfo"==r.method)return;return void await service_directory.getService("SessionService")[r.method](e,t,r)}catch(e){return console.error(e),void response.internalError(t)}let s=service_directory.getService(n);if(!r.method)return console.error("Service call without method name: "+JSON.stringify(r)),void response.invalidRequest(t,"Service call without method name.");if(!s[r.method])return console.error("Service call with invalid method name: "+JSON.stringify(r)),void response.internalError(t);var o=null;try{var a=await service_directory.getService("SessionService").getSessionInfo(e,r.params),i=(o=a.userInfo,a.clientInfo),l=a.roles;if(!checkAccess$1(s,r.method,o,l,t))return;var c=await s[r.method](r.params,i,o,l);return void(c instanceof app_error?response.appError(t,c.errorMsg,c.errorDetail,a.headers):(c||(c={}),response.success(t,c,a.headers)))}catch(e){return console.error(e),void response.internalError(t)}}},service_gateway=ServiceGateway;function checkAccess$1(e,t,r,n,s){if(!e.ACL)return!0;if(n.includes("SUPERADMIN")||n.includes("ADMIN"))return!0;if(e.ACL["*"]){if(!checkAccessHelper(e.ACL["*"],r,n,s))return!1}return!e.ACL[t]||checkAccessHelper(e.ACL[t],r,n,s)}function checkAccessHelper(e,t,r,n){if(!t)return response.loginRequired(n),!1;let s=!0;if(0!=r.length){s=!1;let t=e.length;for(let n=0;n<t;n++){for(let t=0;t<r.length;t++)if(e[n]==r[t]){s=!0;break}if(s)break}}return s||response.accessDenied(n),s}function createCommonjsModule(e,t){return e(t={exports:{}},t.exports),t.exports}var config=createCommonjsModule(function(e){e.exports={LOCALE:"en-US",CDN_URL:"/sp-files",SERVICE_URL:null,IS_MULTI_SITE:!1,IS_MULTI_USER:!1,IS_SELF_REGISTRATION_ALLOWED:!1,PASSWORD_REGEX:/^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#\$%\^&\*])(?=.{8,})/,LOGIN_PREREQS:["tou_check"]}}),FileStore$1=null,_HTTP_PORT=8080,_HTTPS_PORT=8443;const SPServer={async start(e,t){e=constructConfig(e,t);if(await service_loader.init(e),response.init(e),component_registry.init(t),local_file_server.init(e,t),FileStore$1=service_directory.getInternalService("FileStore"),process$1.env.PORT&&(_HTTP_PORT=process$1.env.PORT),process$1.env.HTTPS_PORT&&(_HTTPS_PORT=process$1.env.HTTPS_PORT),process$1.env.HTTPS_CERT&&!process$1.env.HTTPS_KEY||process$1.env.HTTPS_KEY&&!process$1.env.HTTPS_CERT)console.error("You must define both environment variables: HTTPS_KEY and HTTPS_CERT");else if(process$1.env.HTTPS_KEY){let e=process$1.env.HTTPS_KEY.length<200?fs.readFileSync(path.resolve(process$1.env.HTTPS_KEY)):process$1.env.HTTPS_KEY,t=process$1.env.HTTPS_CERT.length<200?fs.readFileSync(path.resolve(process$1.env.HTTPS_CERT)):process$1.env.HTTPS_CERT,r=https.createServer({key:e,cert:t},router),n=http.createServer(redirector);console.log("Starting http server on port "+_HTTP_PORT),console.log("Starting https server on port "+_HTTPS_PORT),n.listen(_HTTP_PORT),r.listen(_HTTPS_PORT)}else{http.createServer(router).listen(_HTTP_PORT),console.log("Starting http server on port "+_HTTP_PORT)}},reloadIndexFile(){local_file_server.readIndexFile()},serviceChanged(e,t){service_loader.serviceChanged(e,t)}};function redirector(e,t){t.on("error",e=>{console.error(e)});let r=e.headers.host.includes(":")?e.headers.host.substring(0,e.headers.host.indexOf(":")):e.headers.host;t.writeHead(302,{Location:"https://"+r+":"+_HTTPS_PORT+e.url}),t.end()}function router(e,t){const{headers:r,method:n,url:s}=e;t.on("error",e=>{console.error(e)}),e.on("error",e=>{console.error(e),t.statusCode=400,t.end()});try{if("OPTIONS"===n)response.options(t);else if("POST"===n)e.headers["sp-file-upload"]?FileStore$1.handleFileUpload(e,t):e.headers["content-type"]&&e.headers["content-type"].startsWith("application/json")?handleServiceRequest(e,t):response.invalidRequest(t);else if("GET"===n){if(e.url.includes(".."))return response.notFound(res);-1!=e.url.indexOf("/files/")?FileStore$1.handleFileDownload(e,t,e.url.substring(e.url.indexOf("/files/")+7)):-1!=e.url.indexOf("/sp-files/")?local_file_server.handleSPFileRequest(t,e.url.substring(e.url.indexOf("/sp-files/")+10)):local_file_server.handleIndexFileRequest(e,t,"index.html")}}catch(e){console.log(e.stack),response.internalError(t)}}function handleServiceRequest(e,t){let r=[];e.on("data",e=>{r.push(e)}).on("end",()=>{r=Buffer.concat(r).toString();try{r=JSON.parse(r)}catch(e){return response.invalidRequest(t,"Invalid JSON.")}service_gateway.handleServiceRequest(e,t,r)})}function constructConfig(e,t){var r=server_config,n=config,s=t?t.config:e;s||(s={});e={};return Object.assign(e,n,r,s),e}var server=SPServer,SP$1={AppError:app_error,Server:server},core=SP$1;module.exports=core;

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).SPPortalEditor=e()}(this,function(){"use strict";var t,e,n,i={SPModal:null,SPRPC:null,deleteComponent:function(t,e,n){s(t,e),d(n)},addComponent:function(t,e,n){var i={};i.id=function(t){var e=0,n=[];!function t(e,n){if(!e.pages)return;for(let i=0;i<e.pages.length;i++)n.push(e.pages[i]),t(e.pages[i],n)}(t,n);for(let t=0;t<n.length;t++){let i=f(n[t]);i>e&&(e=i)}return e}(n)+1,i.name=t,i.config={},i.roles=[],e.push(i),d(n)},createPage:function(t,e,n,i,r,o){var a={};a.path=t.path,a.label=t.label,a.layout=t.layout,a.roles=t.roles,a.isTopLevel=t.isTopLevel,a.folder=t.folder,a.components=[];var s=JSON.stringify(n[a.layout]);a.containers=JSON.parse(s),e.pages.push(a),d(e);var l=o.createPageRouteEntries(a);i.addRoutes(l),r?d(e):d(e,function(){i.push(l[0].path)})},editPage:function(t,e,n,i,r,o,a){if(t.isTopLevel=e.isTopLevel,t.label=e.label,t.roles=e.roles,t.folder=e.folder,t.layout!=e.layout){var s=JSON.stringify(i[e.layout]),l=JSON.parse(s),p=g(t.containers),f=g(l);if(p.length<=f.length)for(let t=0;t<p.length;t++)f[t].components=p[t].components;else{for(let t=0;t<f.length;t++)f[t].components=p[t].components,f[t].components||(f[t].components=[]);var c=0;for(let t=f.length;t<p.length;t++){let e=p[t].components;if(e)for(let t=0;t<e.length;t++)f[c].components.push(e[t]),++c>=f.length&&(c=0)}}t.containers=l,t.layout=e.layout}if(t.path!=e.path){t.path=e.path;var u=a.createPageRouteEntries(t);r.addRoutes(u)}o?d(n):d(n,function(){r.push("/"+t.path)})},deletePage:function(t,e,n,i){for(let r=0;r<e.pages.length;r++)if(e.pages[r]===t){e.pages.splice(r,1),i.setPage(t.path,void 0),n.push("/"),d(e,function(){n.push("/")});break}},dragOver:function(e,n){if(e.preventDefault(),t!==e.target)if(e.target.id&&e.target.id.startsWith("comp-"))r(t,e.target)?o(t,e.target,null,n):o(t,u(e.target),e.target,n);else if(e.target.parentNode&&e.target.parentNode.id&&e.target.parentNode.id.startsWith("comp-"))r(t,e.target.parentNode)?o(t,e.target.parentNode,null,n):o(t,u(e.target.parentNode),e.target.parentNode,n);else if(e.target.id&&e.target.id.startsWith("comp--")){let i=e.target.parentNode.id,r=l(i=i.substring(i.indexOf("-")+1),n),o=a(t.id,n);r.components||(r.components=[]),r.components.push(o)}else if(e.target.parentNode&&e.target.parentNode.id&&e.target.parentNode.id.startsWith("comp--")){let i=e.target.parentNode.parentNode.id,r=l(i=i.substring(i.indexOf("-")+1),n),o=a(t.id,n);r.components||(r.components=[]),r.components.push(o)}},dragEnd:function(i){n?n!==t.nextSibling&&d(i):(t.nextSibling||e!==t.parentNode)&&d(i),t=null,e=null,n=null},dragStart:function(i){if(i.target.id&&i.target.id.startsWith("comp-")){if(i.target.id.startsWith("comp--"))return;i.dataTransfer.effectAllowed="move",i.dataTransfer.setData("text","random"),t=i.target,e=t.parentNode,n=t.nextSibling}},pageDragStart:function(i){console.log("start"),i.target.id&&i.target.id.startsWith("page-")&&(console.log("start1"),i.dataTransfer.effectAllowed="move",i.dataTransfer.setData("text","random"),t=i.target,e=t.parentNode,n=t.nextSibling)},pageDragEnd:function(i){n?n!==t.nextSibling&&d(i):t.nextSibling||d(i),t=null,e=null,n=null},pageDragOver:function(e,n){e.target.id&&e.target.id.startsWith("page-")?r(t,e.target)?b(t,e.target,n):b(t,h(e.target),e.target,n):e.target.parentNode&&e.target.parentNode.id&&e.target.parentNode.id.startsWith("page-")&&(r(t,e.target.parentNode)?b(t,e.target.parentNode,n):b(t,h(e.target.parentNode),e.target.parentNode,n))}};function r(t,e){if(e.parentNode===t.parentNode)for(let n=t.previousSibling;n;n=n.previousSibling)if(n===e)return!0;return!1}function o(t,e,n,i){if(e||(e=n),t.id!=e.id){var r=a(t.id,i);if(r)if(e.id.startsWith("comp--"))l(e.id.substring(e.id.indexOf("-")+2),i).components.push(r);else!function(t,e,n){!function t(e,n,i){if(i.components)for(let t=0;t<i.components.length;t++)if(i.components[t].id==e)return i.components.splice(t,0,n)[0],!0;if(i.containers)for(let o=0;o<i.containers.length;o++){var r=t(e,n,i.containers[o]);if(r)return r}}(t.substring(t.indexOf("-")+1),e,n)}(e.id,r,i)}}function a(t,e){return s(t.substring(t.indexOf("-")+1),e)}function s(t,e){if(e.components)for(let n=0;n<e.components.length;n++)if(e.components[n].id==t){return e.components.splice(n,1)[0]}if(e.containers)for(let n=0;n<e.containers.length;n++){let i=s(t,e.containers[n]);if(i)return i}}function l(t,e){return function t(e,n){if(n.id==e)return n;if(n.containers&&n.containers.length>0)for(let r=0;r<n.containers.length;r++){var i=t(e,n.containers[r]);if(i)return i}}(t,e)}function g(t){var e=[];for(let n=0;n<t.length;n++)p(t[n],e);return e}function p(t,e){if(t.containers&&t.containers.length>0)for(let n=0;n<t.containers.length;n++)p(t.containers[n],e);else e.push(t)}function f(t){var e=0;if(t.containers)for(let i=0;i<t.containers.length;i++){var n=f(t.containers[i]);n>e&&(e=n)}if(t.components)for(let n=0;n<t.components.length;n++)t.components[n].id>e&&(e=t.components[n].id);return e}function d(t,e){i.SPRPC.invoke("SiteService","saveSiteDef",{siteDef:t},e,c)}function c(){i.SPModal.showErrorDialog("msg_failed_to_save_site_def")}function u(t){return t.nextSibling&&t.nextSibling.id&&t.nextSibling.id.startsWith("comp-")?t.nextSibling:t.nextSibling&&t.nextSibling.nextSibling&&t.nextSibling.nextSibling.id&&t.nextSibling.nextSibling.id.startsWith("comp-")?t.nextSibling.nextSibling:null}function h(t){return t.nextSibling&&t.nextSibling.id&&t.nextSibling.id.startsWith("page-")?t.nextSibling:t.nextSibling&&t.nextSibling.nextSibling&&t.nextSibling.nextSibling.id&&t.nextSibling.nextSibling.id.startsWith("page-")?t.nextSibling.nextSibling:null}function b(t,e,n,i){if(e||(e=n),t.id!=e.id){var r=t.id.substring(5),o=null;for(let t=0;t<i.pages.length;t++)if(i.pages[t].path==r){o=i.pages[t],i.pages.splice(t,1);break}if("page--1"==e.id)i.pages.push(o);else{r=e.id.substring(5);for(let t=0;t<i.pages.length;t++)if(i.pages[t].path==r){i.pages.splice(t,0,o);break}}}}return i});
